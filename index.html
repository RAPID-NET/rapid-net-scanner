<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RAPID-NET QR Scanner</title>
  <script src="libs/html5-qrcode.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
    #header { background-color: #4CAF50; color: white; padding: 15px; text-align: center; font-size: 26px; font-weight: bold; }
    #controls { padding: 10px; text-align: center; }
    #reader { width: 300px; margin: 15px auto; background: white; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.2); }
    #status { text-align: center; font-weight: bold; margin-top: 10px; }
    #manual-entry { margin-top: 15px; text-align: center; }
    #manual-entry input { padding: 5px; width: 150px; font-size: 16px; }
    #manual-entry button { padding: 6px 12px; font-size: 16px; margin-left: 5px; }
    table { border-collapse: collapse; width: 90%; margin: 15px auto; background: white; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    tr:nth-child(even) { background: #f9f9f9; }

    /* âœ… Success Popup */
    #popup {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #4CAF50;
      color: white;
      padding: 12px 20px;
      border-radius: 6px;
      font-weight: bold;
      display: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      animation: fadeInOut 2.5s ease-in-out;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translate(-50%, 20px); }
      10% { opacity: 1; transform: translate(-50%, 0); }
      90% { opacity: 1; }
      100% { opacity: 0; transform: translate(-50%, 20px); }
    }
  </style>
</head>
<body>

  <div id="header">RAPID-NET QR SCANNER</div>

  <div id="controls">
    <label><input type="radio" name="scanType" value="in" checked> IN</label>
    <label><input type="radio" name="scanType" value="out"> OUT</label>
  </div>

  <div id="reader"></div>
  <p id="status">ðŸ“· Waiting for scan...</p>

  <div id="manual-entry">
    <input type="text" id="manualId" placeholder="Enter Student ID">
    <button id="manualBtn">Submit Manual Entry</button>
  </div>

  <table id="logTable">
  <thead>
    <tr>
      <th>Student Name</th>
      <th>Grade</th>
      <th>Section</th>
      <th>Direction</th>
      <th>Status</th>
      <th>Time</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

  <div id="popup">âœ… Scan Recorded Successfully</div>

<script>
  const scriptURL = "https://script.google.com/macros/s/AKfycbxxkHcVCoi68OJ7GafuRsrL6XBSM6u6LvyJw73uI5HX87uWqZspBaONZkP0VOvSXl9Q/exec";

  let html5QrCode;
  let scanning = false;
  let lastScanned = "";
  let lastScanTime = 0;

  function getScanType() {
    return document.querySelector('input[name="scanType"]:checked').value;
  }

  function showPopup() {
    const popup = document.getElementById("popup");
    popup.style.display = "block";
    setTimeout(() => popup.style.display = "none", 2500);
  }

  function sendScanData(studentId, lat = "", lng = "", manualOverride = false) {
  const scanType = getScanType();
  const payload = {
    studentId: studentId,
    scanType: scanType,
    lat: lat,
    lng: lng,
    manualOverride: manualOverride
  };

  fetch(scriptURL, {
  method: 'POST',
  body: new URLSearchParams(payload)
})
.then(resp => resp.json())
.then(data => {
  if (data.success) {
    // âœ… Update status text on screen
    document.getElementById("status").innerText = 
  `âœ… ${studentId} - Scan received. Logging...`;
    // âœ… Add a detailed log row (shows name, grade, section, direction, etc.)
    const logTable = document.getElementById("logTable").querySelector("tbody");
    const newRow = logTable.insertRow(0);

    newRow.insertCell(0).textContent = data.studentName || "Unknown";
    newRow.insertCell(1).textContent = data.gradeLevel || "-";
    newRow.insertCell(2).textContent = data.section || "-";
    newRow.insertCell(3).textContent = data.direction?.toUpperCase() || "-";
    newRow.insertCell(4).textContent = data.status || "-";
    newRow.insertCell(5).textContent = data.loggedAt || "-";

    // âœ… Show confirmation popup
    showPopup();

    // âœ… Reset scanner after 2 seconds
    setTimeout(() => {
      document.getElementById("status").innerText = "ðŸ“· Waiting for scan...";
      startScanner();
    }, 2000);
  } else {
    document.getElementById("status").innerText = `âš ï¸ ${data.error || "Scan failed"}`;
  }
})
.catch(err => {
  console.error("Fetch error:", err);
  document.getElementById("status").innerText = "âš ï¸ Error sending data. Restarting...";
  setTimeout(() => {
    document.getElementById("status").innerText = "ðŸ“· Waiting for scan...";
    startScanner();
  }, 3000);
});
}

  function addLogRow(id, direction, status) {
    const tbody = document.querySelector("#logTable tbody");
    const row = tbody.insertRow(0);
    row.insertCell(0).innerText = id;
    row.insertCell(1).innerText = direction.toUpperCase();
    row.insertCell(2).innerText = status;
    row.insertCell(3).innerText = new Date().toLocaleTimeString();
  }

  function startScanner() {
    if (scanning) return;
    scanning = true;

    html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      qrCodeMessage => {
        const now = Date.now();
        if (qrCodeMessage === lastScanned && (now - lastScanTime < 3000)) return; // Prevent double scan
        lastScanned = qrCodeMessage;
        lastScanTime = now;

        html5QrCode.stop().then(() => { scanning = false; });
        navigator.geolocation.getCurrentPosition(pos => {
          sendScanData(qrCodeMessage, pos.coords.latitude, pos.coords.longitude);
        }, () => {
          sendScanData(qrCodeMessage);
        });
      },
      errorMessage => { /* ignore continuous errors */ }
    ).catch(err => {
      console.log("Scanner start failed:", err);
      scanning = false;
      setTimeout(startScanner, 2000);
    });
  }

  // Manual entry handler
 document.getElementById("manualBtn").addEventListener("click", () => {
  const id = document.getElementById("manualId").value.trim();
  if (id) {
    navigator.geolocation.getCurrentPosition(pos => {
      sendScanData(id, pos.coords.latitude, pos.coords.longitude, true);
    }, () => {
      sendScanData(id, "", "", true);
    });
    document.getElementById("manualId").value = "";
    showPopup();
  }
});

  startScanner();
</script>

</body>
</html>


















