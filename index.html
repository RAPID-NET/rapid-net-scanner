<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RAPID-NET QR Scanner</title>

  <!-- Content Security Policy (loosened for inline JS) -->
  <meta http-equiv="Content-Security-Policy" 
        content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com; style-src 'self' 'unsafe-inline'; img-src 'self' data:;">

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2e7d32">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <!-- QR Scanner (No Eval version) -->
  <script type="module" src="https://unpkg.com/html5-qrcode/esm/html5-qrcode.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f8f9fa; }
    header { background:#28a745; color:white; text-align:center; padding:20px 0; font-size:2em; font-weight:bold; }
    main { padding:15px; max-width:500px; margin:auto; }
    .selector, .manual-entry { margin-bottom:15px; }
    .manual-entry input { width:100%; padding:10px; font-size:1em; }
    #reader { width:100%; margin-bottom:15px; }
    #status { font-weight:bold; margin-bottom:15px; }
    table { width:100%; border-collapse: collapse; margin-bottom:30px; }
    th, td { border:1px solid #ccc; padding:6px; text-align:center; font-size:0.9em; }
    .in { background:#c6efce; }
    .out { background:#ffc7ce; }
  </style>
</head>
<body>
  <header>RAPID-NET QR SCANNER</header>
  <main>
    <div class="selector">
      <label><input type="radio" name="scanType" value="in" checked> IN</label>
      <label><input type="radio" name="scanType" value="out"> OUT</label>
      <label><input type="checkbox" id="manualMode"> Manual / Testing Mode</label>
    </div>

    <div id="reader"></div>
    <p id="status">Waiting for scan...</p>

    <div class="manual-entry">
      <input type="text" id="manualStudentId" placeholder="Enter Student ID manually">
      <button onclick="manualScan()">Submit Manual Entry</button>
    </div>

    <table id="scan-log">
      <thead>
        <tr>
          <th>Student ID</th>
          <th>Student Name</th>
          <th>Direction</th>
          <th>Status</th>
          <th>Time</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbxm4nw8lyixQW83-WJ3_ClopMAFmPL5gIn0QRrgVxovpZvGn8RjFWNKRRtwWS_KC2UO/exec";
    let html5QrCode;

    function getScanType() {
      return document.querySelector('input[name="scanType"]:checked').value;
    }

    function sendScanData(studentId, lat="", lng="") {
      const scanType = getScanType();
      fetch(scriptURL, {
        method: 'POST',
        body: new URLSearchParams({ studentId, scanType, lat, lng })
      })
      .then(response => response.json())
      .then(data => updateLog(data))
      .catch(error => handleError(error));
    }

    function updateLog(data) {
      document.getElementById("status").innerText = `✅ ${data.studentName} (${data.status})`;
      const tbody = document.querySelector("#scan-log tbody");
      const row = tbody.insertRow(0);
      row.className = data.direction;
      row.insertCell(0).innerText = data.studentId;
      row.insertCell(1).innerText = data.studentName;
      row.insertCell(2).innerText = data.direction.toUpperCase();
      row.insertCell(3).innerText = data.status;
      row.insertCell(4).innerText = new Date().toLocaleTimeString();

      setTimeout(() => {
        document.getElementById("status").innerText = "Waiting for scan...";
        if(!document.getElementById("manualMode").checked) startScanner();
      }, 2000);
    }

    function handleError(error) {
      document.getElementById("status").innerText = "❌ Error: " + error;
      setTimeout(() => {
        document.getElementById("status").innerText = "Waiting for scan...";
        if(!document.getElementById("manualMode").checked) startScanner();
      }, 3000);
    }

    function manualScan() {
      const studentId = document.getElementById("manualStudentId").value.trim();
      if(studentId) {
        navigator.geolocation.getCurrentPosition(
          pos => sendScanData(studentId, pos.coords.latitude, pos.coords.longitude),
          () => sendScanData(studentId)
        );
        document.getElementById("manualStudentId").value = "";
      } else {
        alert("Please enter a valid Student ID.");
      }
    }

    function startScanner() {
      html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        qrCodeMessage => {
          html5QrCode.stop();
          navigator.geolocation.getCurrentPosition(
            pos => sendScanData(qrCodeMessage, pos.coords.latitude, pos.coords.longitude),
            () => sendScanData(qrCodeMessage)
          );
        }
      ).catch(err => console.log(err));
    }

    document.getElementById("manualMode").addEventListener("change", e => {
      if(e.target.checked) html5QrCode.stop();
      else startScanner();
    });

    startScanner();
  </script>

  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("service-worker.js")
          .then(reg => console.log("✅ Service Worker registered:", reg.scope))
          .catch(err => console.log("❌ Service Worker failed:", err));
      });
    }
  </script>
</body>
</html>
