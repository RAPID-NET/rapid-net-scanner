<!DOCTYPE html>
<html>
<head>
  <title>RAPID-NET QR Scanner</title>
  <script src="libs/html5-qrcode.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    #header { background-color: #4CAF50; color: white; padding: 15px; text-align: center; font-size: 28px; font-weight: bold; }
    #controls { padding: 15px; text-align: center; }
    #reader { width: 300px; margin: 10px auto; }
    #manual-entry { margin-top: 10px; text-align: center; }
    #manual-entry input { padding: 5px; width: 150px; font-size: 16px; }
    #manual-entry button { padding: 6px 12px; font-size: 16px; margin-left: 5px; }
    table { border-collapse: collapse; width: 90%; margin: 15px auto; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    .present { background-color: #c6efce; }
    .late { background-color: #ffeb9c; }
    .going-home { background-color: #9fc5e8; }
    .absent { background-color: #ffc7ce; }
  </style>
</head>
<body>

<div id="header">RAPID-NET QR SCANNER</div>

<div id="controls">
  <label><input type="radio" name="scanType" value="in" checked> IN</label>
  <label><input type="radio" name="scanType" value="out"> OUT</label>
  <label><input type="checkbox" id="manualMode"> Manual / Testing Mode</label>
</div>

<div id="reader"></div>
<p id="status" style="text-align:center;">Waiting for scan...</p>

<div id="manual-entry">
  <input type="text" id="manualId" placeholder="Enter Student ID">
  <button id="manualBtn">Submit Manual Override</button>
</div>

<table id="scan-log">
  <thead>
    <tr>
      <th>Student ID</th>
      <th>Student Name</th>
      <th>Direction</th>
      <th>Status</th>
      <th>Time</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const scriptURL = "YOUR_DOPOST_URL_HERE"; // replace with your Apps Script doPost URL

function getScanType() {
  return document.querySelector('input[name="scanType"]:checked').value;
}

function updateScanLog(data) {
  const tbody = document.querySelector("#scan-log tbody");
  // Remove old row for this student
  const existingRow = Array.from(tbody.rows).find(r => r.cells[0].innerText === data.studentId);
  if(existingRow) tbody.removeChild(existingRow);

  // Add new row at the top
  const row = tbody.insertRow(0);
  row.className = data.status.toLowerCase().replace(/ /g, "-");
  row.insertCell(0).innerText = data.studentId;
  row.insertCell(1).innerText = data.studentName;
  row.insertCell(2).innerText = data.direction.toUpperCase();
  row.insertCell(3).innerText = data.status;
  row.insertCell(4).innerText = new Date().toLocaleTimeString();
}

function sendScanData(studentId, lat="", lng="", manualOverride=false){
  const scanType = getScanType();
  const payload = {
    studentId: studentId,
    scanType: manualOverride ? "manual" : scanType,
    lat: lat,
    lng: lng,
    manualStatus: manualOverride ? "Manual Override" : ""
  };

  fetch(scriptURL, {
    method: 'POST',
    body: new URLSearchParams(payload)
  })
  .then(resp => resp.json())
  .then(data => {
    if(data.error){
      document.getElementById("status").innerText = data.error;
    } else {
      document.getElementById("status").innerText = `✅ ${data.studentName} (${data.direction.toUpperCase()}) - ${data.status}`;
      updateScanLog(data);
    }
    setTimeout(() => { document.getElementById("status").innerText = "Waiting for scan..."; startScanner(); }, 500);
  })
  .catch(err => {
    console.log("Fetch error, data may have been sent.", err);
    document.getElementById("status").innerText = "⚠️ Data may have sent, restarting scanner...";
    setTimeout(() => { document.getElementById("status").innerText = "Waiting for scan..."; startScanner(); }, 1000);
  });
}

let html5QrCode;
let scanning = false;

function startScanner(){
  if(scanning) return;
  scanning = true;
  html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start(
    { facingMode: "environment" },
    { fps:10, qrbox:250 },
    qrCodeMessage => {
      html5QrCode.stop().then(()=>{ scanning=false; });
      const manualMode = document.getElementById("manualMode").checked;
      if(manualMode){
        sendScanData(qrCodeMessage,"","",true);
      } else {
        navigator.geolocation.getCurrentPosition(pos=>{
          sendScanData(qrCodeMessage,pos.coords.latitude,pos.coords.longitude,false);
        }, ()=>{
          sendScanData(qrCodeMessage,"","",false);
        });
      }
    },
    errorMessage => { /* ignore scan errors */ }
  ).catch(err=>{
    scanning=false;
    console.log("Scanner failed to start:", err);
    setTimeout(startScanner, 1000);
  });
}

startScanner();

document.getElementById("manualBtn").addEventListener("click", ()=>{
  const id = document.getElementById("manualId").value.trim();
  if(id){
    const isManualOverride = document.getElementById("manualMode").checked;
    if(isManualOverride){
      sendScanData(id,"","",true);
    } else {
      navigator.geolocation.getCurrentPosition(pos=>{
        sendScanData(id,pos.coords.latitude,pos.coords.longitude,false);
      }, ()=>{
        sendScanData(id,"","",false);
      });
    }
    document.getElementById("manualId").value="";
  }
});
</script>

</body>
</html>
