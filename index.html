<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RAPID-NET QR Scanner</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background-color: #f8fafc;
      margin: 0;
      padding: 0;
    }
    h2 {
      background-color: #2563eb;
      color: white;
      padding: 15px;
      margin: 0;
      font-size: 1.5em;
      letter-spacing: 0.5px;
    }
    .direction-toggle {
      margin: 20px 0;
      font-size: 1.2em;
    }
    label {
      margin: 0 15px;
      cursor: pointer;
      font-weight: bold;
    }
    #reader {
      width: 320px;
      margin: 10px auto;
      border: 2px solid #2563eb;
      border-radius: 10px;
    }
    #manualID {
      padding: 8px;
      width: 180px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    #manualSubmit {
      padding: 8px 16px;
      border: none;
      background-color: #2563eb;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    #manualSubmit:hover {
      background-color: #1e40af;
    }
    #statusMessage {
      margin: 10px;
      font-weight: bold;
      color: #2563eb;
    }
    table {
      width: 95%;
      margin: 20px auto;
      border-collapse: collapse;
      font-size: 0.9em;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #2563eb;
      color: white;
    }
  </style>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>

<body>
  <h2>RAPID-NET QR Scanner</h2>

  <div class="direction-toggle">
    <label>
      <input type="radio" name="direction" value="IN" checked> IN
    </label>
    <label>
      <input type="radio" name="direction" value="OUT"> OUT
    </label>
  </div>

  <div id="reader"></div>
  <p id="statusMessage">Waiting for scan...</p>

  <div style="margin-top: 20px;">
    <input type="text" id="manualID" placeholder="Enter Student ID">
    <button id="manualSubmit">Submit Manual Override</button>
  </div>

  <table id="logTable">
    <thead>
      <tr>
        <th>Student ID</th>
        <th>Student Name</th>
        <th>Direction</th>
        <th>Status</th>
        <th>Time</th>
      </tr>
    </thead>
    <tbody id="logBody"></tbody>
  </table>

  <script>
    const webAppUrl = "https://script.google.com/macros/s/AKfycbw2mTc0E0v26t9d1K-yzFdoIT3dLL6EeLpEJCWYSbjVhCBqIOH8NqwBOj_x8RQgSaGi/exec";// ⬅️ replace with your deployed Web App URL

    // === QR Scanner Setup ===
    const html5QrCode = new Html5Qrcode("reader");
    const qrConfig = { fps: 10, qrbox: 250 };

    async function onScanSuccess(decodedText) {
      const direction = document.querySelector('input[name="direction"]:checked').value;
      const status = direction === "IN" ? "Present" : "Out";
      const now = new Date().toLocaleString("en-PH", { timeZone: "Asia/Manila" });

      document.getElementById("statusMessage").innerText = `Scanned: ${decodedText}`;

      // Show in table immediately
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${decodedText}</td>
        <td>Scanned</td>
        <td>${direction}</td>
        <td>${status}</td>
        <td>${now}</td>
      `;
      document.getElementById("logBody").prepend(row);

      // Send to Google Apps Script
      try {
        const response = await fetch(webAppUrl, {
          method: "POST",
          body: JSON.stringify({
            studentID: decodedText,
            direction: direction,
            status: status,
            time: now
          }),
          headers: { "Content-Type": "application/json" }
        });
        console.log(await response.text());
      } catch (error) {
        console.error("Error sending scan:", error);
      }
    }

    async function startScanner() {
      try {
        const devices = await Html5Qrcode.getCameras();
        if (devices && devices.length) {
          html5QrCode.start(
            { facingMode: "environment" },
            qrConfig,
            onScanSuccess
          );
        }
      } catch (err) {
        console.error("Error starting scanner:", err);
      }
    }

    // === Manual Override Submit ===
    document.getElementById("manualSubmit").addEventListener("click", async () => {
      const studentID = document.getElementById("manualID").value.trim();
      if (!studentID) {
        alert("Please enter a Student ID.");
        return;
      }

      const direction = document.querySelector('input[name="direction"]:checked').value;
      const status = direction === "IN" ? "Present" : "Out";
      const now = new Date().toLocaleString("en-PH", { timeZone: "Asia/Manila" });

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${studentID}</td>
        <td>Manual Entry</td>
        <td>${direction}</td>
        <td>${status}</td>
        <td>${now}</td>
      `;
      document.getElementById("logBody").prepend(row);

      try {
        const response = await fetch(webAppUrl, {
          method: "POST",
          body: JSON.stringify({ studentID, direction, status, time: now }),
          headers: { "Content-Type": "application/json" }
        });
        console.log(await response.text());
      } catch (error) {
        console.error("Error submitting manual entry:", error);
      }

      document.getElementById("manualID").value = "";
    });

    startScanner();
  </script>
</body>
</html>
