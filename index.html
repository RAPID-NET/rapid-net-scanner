<!DOCTYPE html>
<html>
<head>
  <title>RAPID-NET QR Scanner</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 10px;
      padding: 0;
      text-align: center;
      background: #f9f9f9;
    }
    #reader {
      width: 100%;
      max-width: 400px;
      height: 300px;
      margin: 10px auto;
      border: 2px solid #ccc;
      background: #000;
    }
    table { 
      border-collapse: collapse; 
      width: 100%; 
      margin-top: 15px; 
      font-size: 14px;
    }
    th, td { 
      border: 1px solid #ccc; 
      padding: 6px; 
      text-align: center; 
    }
    .Present { background-color: #c6efce; }
    .Late { background-color: #ffeb9c; }
    .Very\ Late { background-color: #f4cccc; }
    .Going\ Home { background-color: #9fc5e8; }
    .Absent { background-color: #ffc7ce; }
    .manual { background-color: #d9d2e9; }
    label { margin: 0 10px; font-weight: bold; }
    button { padding: 6px 12px; margin-top: 10px; }
    input[type=text] { padding: 6px; width: 150px; }
  </style>
</head>
<body>
  <h2>RAPID-NET QR Scanner</h2>

  <!-- Scan type selector -->
  <label><input type="radio" name="scanType" value="in" checked> IN</label>
  <label><input type="radio" name="scanType" value="out"> OUT</label>

  <div id="reader"></div>
  <p id="status">Waiting for scan...</p>

  <!-- Manual override -->
  <div>
    <input type="text" id="manualId" placeholder="Enter Student ID">
    <select id="manualStatus">
      <option value="Present">Present</option>
      <option value="Late">Late</option>
      <option value="Very Late">Very Late</option>
      <option value="Going Home">Going Home</option>
      <option value="Absent">Absent</option>
    </select>
    <button onclick="manualSubmit()">Submit Manual Override</button>
  </div>

  <!-- Live table -->
  <table id="scan-log">
    <thead>
      <tr>
        <th>Student ID</th>
        <th>Student Name</th>
        <th>Direction</th>
        <th>Status</th>
        <th>Time</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbzdIz9DEsXWdXQWZ5xx6xL3cE8BNlBRkIDUUiz4a-HwJdGy_DO3TigTAhS7GinBbYpO/exec";

    let html5QrCode;

    function getScanType() {
      return document.querySelector('input[name="scanType"]:checked').value;
    }

    function sendScanData(studentId, lat = "", lng = "", manualStatus = null) {
      const scanType = manualStatus ? "manual" : getScanType();

      fetch(scriptURL, {
        method: 'POST',
        body: new URLSearchParams({
          studentId: studentId,
          scanType: scanType,
          manualStatus: manualStatus || "",
          lat: lat,
          lng: lng
        })
      })
      .then(response => response.json())
      .then(data => {
        document.getElementById("status").innerText = `✅ ${data.studentName} (${data.status})`;

        // Update live table
        const tbody = document.querySelector("#scan-log tbody");
        const row = tbody.insertRow(0);
        row.className = data.status.replace(" ", "\\ ");
        row.insertCell(0).innerText = data.studentId;
        row.insertCell(1).innerText = data.studentName;
        row.insertCell(2).innerText = data.direction.toUpperCase();
        row.insertCell(3).innerText = data.status;
        row.insertCell(4).innerText = new Date().toLocaleTimeString();

        // Restart scanner after 2 sec if not manual
        if(!manualStatus) setTimeout(startScanner, 2000);
      })
      .catch(error => {
        document.getElementById("status").innerText = "❌ Error: " + error;
        if(!manualStatus) setTimeout(startScanner, 3000);
      });
    }

    function startScanner() {
      if(html5QrCode) html5QrCode.stop().catch(()=>{});
      html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        qrCodeMessage => {
          html5QrCode.stop();
          navigator.geolocation.getCurrentPosition(function(position) {
            sendScanData(qrCodeMessage, position.coords.latitude, position.coords.longitude);
          }, function() {
            sendScanData(qrCodeMessage);
          });
        },
        errorMessage => {
          // console.log(`QR Scan error: ${errorMessage}`);
        }
      );
    }

    function manualSubmit() {
      const id = document.getElementById("manualId").value.trim();
      const status = document.getElementById("manualStatus").value;
      if(!id) return alert("Please enter Student ID");
      sendScanData(id, "", "", status);
      document.getElementById("manualId").value = "";
    }

    startScanner();
  </script>
</body>
</html>
