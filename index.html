<!DOCTYPE html>
<html>
<head>
  <title>RAPID-NET QR Scanner</title>
  <script src="libs/html5-qrcode.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    #header { background-color: #4CAF50; color: white; padding: 15px; text-align: center; font-size: 28px; font-weight: bold; }
    #controls { padding: 15px; text-align: center; }
    #reader { width: 300px; margin: 10px auto; }
    #manual-entry { margin-top: 10px; text-align: center; }
    #manual-entry input { padding: 5px; width: 150px; font-size: 16px; }
    #manual-entry button { padding: 6px 12px; font-size: 16px; margin-left: 5px; }
    table { border-collapse: collapse; width: 90%; margin: 15px auto; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    .present { background-color: #c6efce; }
    .late { background-color: #ffeb9c; }
    .very-late { background-color: #f4cccc; }
    .going-home { background-color: #9fc5e8; }
    .absent { background-color: #ffc7ce; }
  </style>
</head>
<body>

<div id="header">RAPID-NET QR SCANNER</div>

<div id="controls">
  <label><input type="radio" name="scanType" value="in" checked> IN</label>
  <label><input type="radio" name="scanType" value="out"> OUT</label>
  <label><input type="checkbox" id="manualMode"> Manual / Testing Mode</label>
</div>

<div id="reader"></div>
<p id="status" style="text-align:center;">Waiting for scan...</p>

<div id="manual-entry">
  <input type="text" id="manualId" placeholder="Enter Student ID">
  <button id="manualBtn">Submit Manual Override</button>
</div>

<table id="scan-log">
  <thead>
    <tr>
      <th>Student ID</th>
      <th>Student Name</th>
      <th>Direction</th>
      <th>Status</th>
      <th>Time</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const scriptURL = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec"; // replace with your Apps Script URL
let html5QrCode;
let scanning = false; // prevent multiple scans

function getScanType() {
  return document.querySelector('input[name="scanType"]:checked').value;
}

function sendScanData(studentId, lat="", lng="", manualOverride=false){
  const scanType = getScanType();
  const payload = {
    studentId: studentId,
    scanType: manualOverride ? "manual" : scanType,
    lat: lat,
    lng: lng,
    manualStatus: manualOverride ? "Manual Override" : "",
    manualOverride: manualOverride.toString()
  };

  fetch(scriptURL, {
    method: 'POST',
    body: new URLSearchParams(payload)
  })
  .then(resp => resp.json())
  .then(data => {
    scanning = false; // allow next scan
    if(data.error){
      document.getElementById("status").innerText = data.error;
    } else {
      document.getElementById("status").innerText = `✅ ${data.studentName} (${data.direction.toUpperCase()})`;
      const tbody = document.querySelector("#scan-log tbody");
      const row = tbody.insertRow(0);
      row.className = data.direction.toLowerCase();
      row.insertCell(0).innerText = data.studentId;
      row.insertCell(1).innerText = data.studentName;
      row.insertCell(2).innerText = data.direction.toUpperCase();
      row.insertCell(3).innerText = "Scanned";
      row.insertCell(4).innerText = new Date().toLocaleTimeString();
    }
    setTimeout(()=>{ document.getElementById("status").innerText = "Waiting for scan..."; startScanner(); }, 1000);
  })
  .catch(err => {
    scanning = false;
    document.getElementById("status").innerText = "❌ Error: "+err;
    setTimeout(()=>{ document.getElementById("status").innerText="Waiting for scan..."; startScanner(); },1500);
  });
}

function startScanner(){
  if(html5QrCode) html5QrCode.stop().catch(()=>{});
  html5QrCode = new Html5Qrcode("reader");

  html5QrCode.start(
    { facingMode: "environment" },
    { fps:10, qrbox:250 },
    qrCodeMessage => {
      if(scanning) return; // ignore if already scanning
      scanning = true;
      html5QrCode.stop().finally(()=>{
        const isManual = document.getElementById("manualMode").checked;
        navigator.geolocation.getCurrentPosition(pos=>{
          sendScanData(qrCodeMessage,pos.coords.latitude,pos.coords.longitude,isManual);
        }, ()=>{
          sendScanData(qrCodeMessage,"","",isManual);
        });
      });
    },
    errorMessage => { /* optional: console.log(errorMessage); */ }
  );
}

startScanner();

const manualBtn = document.getElementById("manualBtn");
const manualId = document.getElementById("manualId");
const manualMode = document.getElementById("manualMode");

manualBtn.addEventListener("click", ()=>{
  const id = manualId.value.trim();
  if(id){
    const isManualOverride = manualMode.checked;
    navigator.geolocation.getCurrentPosition(pos=>{
      sendScanData(id,pos.coords.latitude,pos.coords.longitude,isManualOverride);
    }, ()=>{
      sendScanData(id,"","",isManualOverride);
    });
    manualId.value="";
  }
});
</script>

</body>
</html>
